generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
}

enum MachineStatus {
  AVAILABLE
  IN_CONTRACT
  IN_WORKSHOP
  IN_TRANSFER
  INACTIVE
}

enum WorkOrderType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  CANCELLED
}

enum ContractStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum LegalDocumentType {
  POLIZA
  SOAT
  TECNICO_MECANICA
}

model LegalDocument {
  id              String            @id @default(uuid())
  machineId       String
  type            LegalDocumentType
  insuranceName   String?
  policyNumber    String?
  expirationDate  DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  machine         Machine           @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([machineId, type])
}

model Machine {
  id               String        @id @default(uuid())
  code             String        @unique
  type             String
  brand            String
  model            String
  imageUrl         String?
  year             Int?
  serialNumber     String?
  hourMeter        Float?
  acquisitionDate  DateTime?
  acquisitionValue Float?
  usefulLifeHours  Float?
  currentLocation  String?
  
  // Mantenimiento preventivo
  hoursSinceLastMaintenance Float?
  maintenanceIntervalHours Float?
  lastMaintenanceDate DateTime?

  status           MachineStatus
  previousStatus   MachineStatus?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  workOrders       WorkOrder[]
  assignments      MachineAssignment[]
  hourMeterLogs    HourMeterLog[]
  legalDocuments   LegalDocument[]
}


model WorkOrder {
  id              String          @id @default(uuid())
  machineId       String
  type            WorkOrderType
  status          WorkOrderStatus
  entryDate       DateTime
  exitDate        DateTime?
  sparePartsCost  Float
  laborCost       Float
  totalCost       Float
  downtimeHours  Float?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  machine         Machine         @relation(fields: [machineId], references: [id])
  logs            WorkOrderLog[]
}

model WorkOrderLog {
  id          String    @id @default(uuid())
  workOrderId String
  date        DateTime  @default(now())
  description String
  fileUrl     String?   // URL del archivo subido (factura, foto, etc.)
  fileName    String?   // Nombre original del archivo
  fileType    String?   // Tipo MIME del archivo
  createdAt   DateTime  @default(now())
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model Contract {
  id          String         @id @default(uuid())
  code        String
  customer    String
  startDate   DateTime
  endDate     DateTime
  value       Float
  monthlyValue Float?
  plazo       Int?
  status      ContractStatus
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  assignments MachineAssignment[]
}

model MachineAssignment {
  id              String   @id @default(uuid())
  contractId      String
  machineId       String
  hourlyRate      Float?
  workedHours     Float
  maintenanceCost Float
  generatedIncome Float
  margin          Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  machine         Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@unique([machineId, contractId])
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  
  // Permisos de máquinas
  canCreateMachine    Boolean @default(false)
  canEditMachine      Boolean @default(false)
  canDeleteMachine    Boolean @default(false)
  canUpdateHourMeter  Boolean @default(false)
  
  // Permisos de contratos
  canCreateContract   Boolean @default(false)
  canEditContract     Boolean @default(false)
  canDeleteContract   Boolean @default(false)
  canAssignMachine    Boolean @default(false)
  
  // Permisos de órdenes de trabajo
  canCreateWorkOrder  Boolean @default(false)
  canEditWorkOrder    Boolean @default(false)
  canDeleteWorkOrder  Boolean @default(false)
  canCloseWorkOrder   Boolean @default(false)
  
  // Permisos de documentos legales
  canEditLegalDocuments Boolean @default(false)
  
  // Permisos de usuarios
  canCreateUser       Boolean @default(false)
  canEditUser         Boolean @default(false)
  canDeleteUser       Boolean @default(false)
  canManageRoles      Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  email     String?
  role      String   @default("OPERATOR") // Reference to Role name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  hourMeterLogs HourMeterLog[]
}

model HourMeterLog {
  id         String   @id @default(uuid())
  machineId  String
  userId     String
  previousValue Float
  newValue   Float
  createdAt  DateTime @default(now())
  machine    Machine  @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])
}
